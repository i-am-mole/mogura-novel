# mogura-novel
趣味で書いている小説を公開している個人サイト[もぐらノベル](https://www.mogura-novel.com)のコンテンツを保存するリポジトリ。

## コンテンツ保守方法
1. [private/](private/) のコンテンツを後述する『自己紹介編集方法』『小説情報編集方法』『本文編集方法』『画像編集方法』に従って編集する
1. css ファイルを [private/css/style.css](private/css/style.css) に保存する
1. [venv.bat](venv.bat) を使うなどして [requirements.txt](requirements.txt) に従って Python の仮想環境を作成・有効化する
1. ルートディレクトリより静的サイト生成ツール (SSG) を `python tools/publish.py` で実行すると SSG がGithub pages の公開対象である [public/](public/) に公開コンテンツ, [data/update_history.csv](data/update_history.csv) にコンテンツの更新日時を出力する

ブランチの切り方は [DEVELOPMENT.md](DEVELOPMENT.md) に記載の通り。

コンテンツには独自の記法により SSG にルビを振らせることができる。詳しくは『独自のルビ記法について』を参照。

### 自己紹介編集方法
[private/self_intro.md](private/self_intro.md) に自己紹介文を Markdown で記載する。

SSG は当該ファイルを検証し、以下を検知すると不正データと見なす。

- 自己紹介文がブランクであること
- h1 レベルの見出しが使用されていること

### 小説情報編集方法
private/ 直下に小説単位でディレクトリを切る（小説ディレクトリ）。
小説ディレクトリの名称は workslug になる想定。SSG は "private/blog/", "private/wiki/", "private/css/" というディレクトリを無視するので使わないこと。

小説情報は Markdown ファイル private/<小説ディレクトリ>/index.md に以下の書式で書く。

```index.md
# title
<小説のタイトル>
# tags
- <タグ1>
- <タグ2>
# status
<連載ステータス>
# outline
<あらすじ>
# external links
- <[公開先1サイト名](公開先1URL)>
- <[公開先2サイト名](公開先2URL)>
# chapters
<章タイトル1>: <章区切り番号1>
<章タイトル2>: <章区切り番号2>
```

SSG は h1 レベルの見出しをキー、直下のコンテンツを値と見なして公開コンテンツ出力に用いる。
見出しの説明は下表の通りである。

|見出し|必須 or オプション|説明|
|:---|:---|:---|
|title|必須|小説のタイトル|
|tags|必須|小説に付与するタグの一覧を Markdown のリストで書く|
|status|必須|連載ステータス。「連載中」「完結済」「更新停止」のいずれか|
|outline|必須|小説のあらすじを Markdown で書く|
|external links|オプション|他サイトでも公開している小説の場合は公開先を Markdown のリンクのリストで書く。もぐらノベル限定公開の場合は当該見出しは書かない|
|chapters|オプション|小説の各話を章で区切りたい場合に YAML 形式で書く。キーが章のタイトル、値は整数値で「章区切り番号」を示す。章の順番は章区切り番号の並び順に対応する。章区切りが不要な場合は当該見出しは書かない|

章区切りの考え方については後述の『章区切りと話数番号について』で補足する。

SSG は当該ファイルを検証し、以下を不正として検出する。

- h1 レベルの見出しについて
  - 表に無い h1 レベルの見出しが存在すること
  - 表で必須になっている見出しが揃っていないこと
  - 配下にコンテンツが存在しない見出しが存在すること
- `title` 配下が複数行であること
- `tags` 配下が要素数1以上の Markdown のリストではないこと
- `status` 配下が "連載中", "完結済", "更新停止" 以外であること
- `external links` 配下が要素数1以上で各要素が Markdown リンクのリストではないこと
- `chapters` について
  - 配下を YAML としてパース出来ないこと
  - YAML のキー（章タイトル）又は値（章区切り番号）がユニークでないこと
  - YAML の値に整数でないものが存在すること

### 本文編集方法
一話毎に一つのファイルを作成し本文を書く。

SSG は小説ディレクトリ直下の以下の条件を満たすファイルを小説の話と見なす。

- 拡張子が .md である
- ファイル名 != "index.md"
- ファイル名先頭一文字 != "_"

話は以下の書式の Markdown ファイルに書く。

```本文フォーマット.md
# title
<話のタイトル>
# number
<話数番号>
# content
<本文>
```

SSG は h1 レベルの見出しをキー、直下のコンテンツを値と見なして公開コンテンツ出力に用いる。
見出しの説明は下表の通りである。

|見出し|必須 or オプション|説明|
|:---|:---|:---|
|title|必須|話のタイトル|
|number|必須|話数番号を示す整数値。話の順番は話数番号の順番に対応する。また当該小説の index.md に `chapters` が定められている場合は章区切りにも用いられる|
|content|必須|本文を Markdown で書く|

SSG は当該ファイルを検証し、以下を不正として検出する。

- h1 レベルの見出しについて
  - 表に無い h1 レベルの見出しが存在すること
  - 表で必須になっている見出しが揃っていないこと
  - 配下にコンテンツが存在しない見出しが存在すること
- `title` 配下のコンテンツが複数行であること
- `number` について
  - 配下に整数値以外が指定されていること
  - 全ての本文のファイルを通じて値がユニークでないこと
  - どの章に属するのは不明な話が存在すること

話数番号からどの章の話かを求める方法については後述の『章区切りと話数番号について』で説明する。

### 画像編集方法
private/ に以下の favicon を準備する

- favicon.ico
- favicon-16x16.png
- favicon-32x32.png
- apple-touch-icon.png

※最初のファイルは [ImageMagick](https://imagemagick.org/) で作成

### 独自のルビ記法について
『|ルビを振る対象文字列<ルビ>』と書く。
例えば『漢字』に「かんじ」というルビを振りたい場合は『|漢字<かんじ>』と書く。
SSG が以下の箇所に書かれた独自のルビ記法を適切な HTML に変換する。

- 自己紹介
- 小説のタイトル
- 小説のあらすじ
- 小説の章タイトル
- 話のタイトル
- 話の本文

他の箇所で独自のルビ記法を用いても HTML には変換されない。

### 章区切りと話数番号について
private/小説ディレクトリ/index.md に `chapters` の見出しを書けば各話を章で区切ることができる。

章区切り番号と各話の話数番号 (`number`) によって各話がどの章に属するかを判定する。
判定ルールは以下の通りである。

- 話は『話数番号≦章区切り番号』が成り立つ最大の章区切り番号に対応する章に属する
- 『話数番号≦章区切り番号』が成り立つ章が存在しない話は「どの章に属するのは不明」扱いする

例を挙げる。

ある小説の index.md の `chapters` が下記の通りとする。

```markdown
# chapters
異世界へ: 10
人生一発逆転: 20
```

章の順番は章区切り番号の並び順に対応するためこの小説の章は次の通りになる。

- 1章: 異世界へ (章区切り番号10)
- 2章: 人生一発逆転 (章区切り番号20)

次に、当該小説は全5話であり、各話のファイルは以下の通りとする。

```プロローグ.md
# title
お約束のトラック
# number
-1
# content
仕事で疲弊して帰る途中トラックに轢かれた
```

```goddess.md
# title
女神の恩寵
# number
9
# content
俺は死んだが女神は俺に異世界での二度目の人生を与えた
```

```isekai.md
# title
ここが異世界
# number
10
# content
スライム、ドラゴン、魔法・・・ここが異世界か！
```

```cheat.md
# title
チート能力
# number
15
# content
モンスターやいけ好かない貴族をチート能力で半殺し！
```

```happyend.md
# title
異世界最高
# number
19
# content
金、権力、暴力！　異世界暮らしは最高だ！
```

話の順番は話数番号の順番に対応するため、話の並び順は次の通りになる。

- 1話: お約束のトラック (話数番号-1)
- 2話: 女神の恩寵 (話数番号9)
- 3話: ここが異世界 (話数番号10)
- 4話: チート能力 (話数番号15)
- 5話: 異世界最高 (話数番号19)

章区切り番号 (`chapters`) は1章が10, 2章が20である。
1~3話目の話数番号 (`number`) は10以下だが、4~5話目は11以上20以下である。
従って、各話と章の関係は以下の通りに整理できる。

- 1章 (章区切り番号10)
  - 1話 (話数番号-1)
  - 2話 (話数番号9)
  - 3話 (話数番号10)
- 2章 (章区切り番号20)
  - 4話 (話数番号15)
  - 5話 (話数番号19)

仮に、次の新規の話が追加されたとする。

```epilogue.md
# title
エピローグ
# number
21
# content
別の異世界転生者が現れただと！？
```

話数番号21が最大の章区切り番号である20を超えているため、この話はどの章に属するのか判定できない。
SSG には不正データと見なされる。

## SSG が作成するファイルについて
SSG は以下の2種類のファイルを作成する。

- **公開コンテンツ**: public/ のファイル
- **更新履歴**: data/update_history.csv のこと。もぐらノベルに更新日付を正しく表示するために必要な情報をまとめる

### 公開コンテンツ
public/ は Github pages の公開対象である。
SSG がメンテナンスするためマニュアルでの編集は不要の想定。

サイトトップは [public/index.html](public/index.html) である。

public/ 直下に private/ 直下と同じ構造で小説毎にディレクトリを切る（小説ディレクトリ）。
小説ディレクトリに小説を表示するのに必要なファイルを保存していく。

『小説トップ』は index.html となる。
『話』は話の順番に 1.html, 2.html, ... となる。

css は private/style.css を public/style.css にコピーする。
Favicon は private/ 直下のファイルを public/ 直下にコピーする。


### 更新履歴
もぐらノベルには各種コンテンツの更新日付を表示する。

更新日付とは SSG でコンテンツを更新した日付である。
コンテンツを更新したかどうかは前回 SSG が出力したコンテンツと比較して判断する。
SSG はこの判断を行うのに必要な情報を更新履歴 (data/update_history.csv) に保存し適宜参照する。

更新履歴は以下の3つのカラムを持つヘッダ無しカンマ区切りファイルである。

- **ファイル名**: SSG が処理する private/ 配下のファイル名。プロジェクトルートからの相対パス
- **ハッシュ**: コンテンツのハッシュ
- **最終更新日時**: ISO フォーマットのタイムスタンプ

更新履歴のキーは「ファイル名」である。
更新履歴は git で追跡するため、無用な差分を防ぐために SSG はキーでソート済みのデータを更新履歴に出力する。
SSG はキーが更新履歴に存在しない、又は存在するがハッシュが異なる場合、そのコンテンツは更新されたと判定する。

更新履歴をマニュアルでメンテナンスすることは基本的に無い想定である。
ただし、万一 private/ にある公開済小説ディレクトリや配下のファイルの名称を変えた場合、更新履歴をマニュアルで編集して整合性を保たなければならないので極力避ける。
